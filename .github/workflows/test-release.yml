name: Test Published Release
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Published 1ls version to test (leave empty for latest on npm)'
        required: false
        type: string

jobs:
  test-published-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Version to Test
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(npm view 1ls version)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Testing 1ls version: $VERSION"

      - name: Wait for NPM Package Availability
        run: |
          echo "Waiting for 1ls@${{ steps.version.outputs.version }} to be available on npm..."
          for i in {1..30}; do
            if npm view 1ls@${{ steps.version.outputs.version }} version >/dev/null 2>&1; then
              echo "Package 1ls@${{ steps.version.outputs.version }} is available on npm"
              break
            fi
            echo "Attempt $i/30: Package not yet available, waiting 30 seconds..."
            sleep 30
          done

      - name: Build Test Docker Image
        run: |
          cat > Dockerfile.release-test << 'EOF'
          FROM node:24-alpine

          RUN apk add --no-cache bash

          WORKDIR /app

          ARG ONELS_VERSION
          RUN echo "Installing 1ls@${ONELS_VERSION}" && \
              npm install -g 1ls@${ONELS_VERSION}

          # Create test fixtures
          RUN echo '{"name": "test", "users": [{"name": "Alice", "age": 30}, {"name": "Bob", "age": 25}]}' > test.json
          RUN echo 'name: test' > test.yaml
          RUN echo 'name,age' > test.csv && echo 'Alice,30' >> test.csv && echo 'Bob,25' >> test.csv

          CMD ["/bin/sh"]
          EOF

          docker build \
            --build-arg ONELS_VERSION=${{ steps.version.outputs.version }} \
            -f Dockerfile.release-test \
            -t onels-release-test .

      - name: Verify Installation
        run: |
          echo "Verifying 1ls installation..."
          docker run --rm onels-release-test bash -c "
            1ls --version
            1ls --help
            echo 'Installation verified'
          "

      - name: Test JSON Processing
        run: |
          echo "Testing JSON processing..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing property access...'
            echo '{\"name\": \"John\", \"age\": 30}' | 1ls '.name'

            echo 'Testing array filter...'
            echo '[1, 2, 3, 4, 5]' | 1ls '.filter(x => x > 2)'

            echo 'Testing array map...'
            echo '[1, 2, 3]' | 1ls '.map(x => x * 2)'

            echo 'Testing nested access...'
            echo '{\"user\": {\"name\": \"Alice\"}}' | 1ls '.user.name'

            echo 'Testing chained methods...'
            echo '[{\"name\": \"Alice\", \"age\": 30}, {\"name\": \"Bob\", \"age\": 25}]' | 1ls '.filter(x => x.age > 26).map(x => x.name)'

            echo 'JSON processing tests passed'
          "

      - name: Test File Operations
        run: |
          echo "Testing file operations..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing readFile...'
            1ls readFile test.json '.name'

            echo 'Testing readFile with expression...'
            1ls readFile test.json '.users.map(u => u.name)'

            echo 'File operations tests passed'
          "

      - name: Test Multi-Format Support
        run: |
          echo "Testing multi-format support..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing YAML input...'
            echo 'name: John
            age: 30' | 1ls '.name'

            echo 'Testing CSV input...'
            echo 'name,age
            John,30
            Jane,25' | 1ls '.map(x => x.name)'

            echo 'Multi-format tests passed'
          "

      - name: Test Object Operations
        run: |
          echo "Testing object operations..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing keys...'
            echo '{\"a\": 1, \"b\": 2}' | 1ls '.{keys}'

            echo 'Testing values...'
            echo '{\"a\": 1, \"b\": 2}' | 1ls '.{values}'

            echo 'Testing entries...'
            echo '{\"a\": 1, \"b\": 2}' | 1ls '.{entries}'

            echo 'Object operations tests passed'
          "

      - name: Test Array Methods
        run: |
          echo "Testing array methods..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing reduce...'
            echo '[1, 2, 3, 4]' | 1ls '.reduce((acc, x) => acc + x, 0)'

            echo 'Testing find...'
            echo '[1, 2, 3, 4, 5]' | 1ls '.find(x => x > 3)'

            echo 'Testing some...'
            echo '[1, 2, 3]' | 1ls '.some(x => x > 2)'

            echo 'Testing every...'
            echo '[2, 4, 6]' | 1ls '.every(x => x % 2 === 0)'

            echo 'Testing sort...'
            echo '[3, 1, 2]' | 1ls '.sort((a, b) => a - b)'

            echo 'Testing reverse...'
            echo '[1, 2, 3]' | 1ls '.reverse()'

            echo 'Array methods tests passed'
          "

      - name: Test CLI Options
        run: |
          echo "Testing CLI options..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing --raw option...'
            echo '{\"name\": \"John\"}' | 1ls --raw '.name'

            echo 'Testing --pretty option...'
            echo '{\"a\":1,\"b\":2}' | 1ls --pretty '.'

            echo 'Testing --compact option...'
            echo '{\"a\": 1, \"b\": 2}' | 1ls --compact '.'

            echo 'Testing --type option...'
            echo '[1, 2, 3]' | 1ls --type '.'

            echo 'CLI options tests passed'
          "

      - name: Test Shortcuts
        run: |
          echo "Testing shortcuts..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing --shortcuts...'
            1ls --shortcuts | head -20

            echo 'Testing shortcut expansion...'
            1ls --expand '.mp(x => x * 2)'

            echo 'Testing shortcut compression...'
            1ls --shorten '.map(x => x * 2)'

            echo 'Shortcuts tests passed'
          "

      - name: Performance Check
        run: |
          echo "Running performance checks..."
          docker run --rm onels-release-test bash -c "
            echo 'Testing command execution time...'
            time 1ls --help >/dev/null

            echo 'Testing JSON processing time...'
            time echo '[1,2,3,4,5]' | 1ls '.map(x => x * 2)' >/dev/null

            echo 'Performance checks passed'
          "

      - name: Report Test Results
        run: |
          echo "Test Summary"
          echo "==============="
          echo "Tested 1ls version: ${{ steps.version.outputs.version }}"
          echo "Installation: PASSED"
          echo "JSON processing: PASSED"
          echo "File operations: PASSED"
          echo "Multi-format support: PASSED"
          echo "Object operations: PASSED"
          echo "Array methods: PASSED"
          echo "CLI options: PASSED"
          echo "Shortcuts: PASSED"
          echo "Performance: PASSED"
          echo ""
          echo "Published package is working correctly!"

      - name: Create Test Report
        if: always()
        run: |
          cat > test-report.md << EOF
          # 1ls Release Test Report

          **Version Tested:** ${{ steps.version.outputs.version }}
          **Test Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Status:** PASSED

          ## Test Coverage
          - Installation verification
          - JSON processing (property access, filter, map, chaining)
          - File operations (readFile)
          - Multi-format support (JSON, YAML, CSV)
          - Object operations (keys, values, entries)
          - Array methods (reduce, find, some, every, sort, reverse)
          - CLI options (raw, pretty, compact, type)
          - Shortcuts (expand, shorten)
          - Performance validation

          ## Summary
          All tests passed successfully. The published package is ready for use.
          EOF

          echo "Test report created:"
          cat test-report.md
